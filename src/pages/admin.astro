---
// Admin page for managing portfolio entries
// Authentication: Simple password protection (set via env var ADMIN_PASSWORD)

import Layout from '../layouts/Layout.astro';
import fs from 'fs';
import path from 'path';

const PORTFOLIO_DIR = 'src/content/portfolio';
const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD || 'admin123';

interface PortfolioEntry {
  slug: string;
  title: string;
  date: string;
  thumbnail?: string;
  content: string;
  frontmatter: any;
}

// Read all portfolio entries
function getPortfolioEntries(): PortfolioEntry[] {
  const entries: PortfolioEntry[] = [];
  const yearsDir = path.join(process.cwd(), PORTFOLIO_DIR);

  if (!fs.existsSync(yearsDir)) {
    return entries;
  }

  const years = fs.readdirSync(yearsDir, { withFileTypes: true })
    .filter(d => d.isDirectory());

  for (const year of years) {
    const yearDir = path.join(yearsDir, year.name);
    const files = fs.readdirSync(yearDir)
      .filter(f => f.endsWith('.md'));

    for (const file of files) {
      const filePath = path.join(yearDir, file);
      const content = fs.readFileSync(filePath, 'utf-8');
      const slug = file.replace('.md', '');

      // Parse frontmatter
      const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
      let frontmatter: any = {};
      let bodyContent = content;

      if (frontmatterMatch) {
        const frontmatterText = frontmatterMatch[1];
        frontmatter = parseFrontmatter(frontmatterText);
        bodyContent = content.replace(frontmatterMatch[0], '');
      }

      entries.push({
        slug,
        title: frontmatter.title || slug,
        date: frontmatter.date || '',
        thumbnail: frontmatter.thumbnail,
        content: bodyContent,
        frontmatter
      });
    }
  }

  return entries.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
}

function parseFrontmatter(text: string): any {
  const result: any = {};
  const lines = text.split('\n');

  for (const line of lines) {
    const match = line.match(/^(\w+):\s*(.+)$/);
    if (match) {
      const [, key, value] = match;
      result[key] = parseValue(value);
    }
  }

  return result;
}

function parseValue(value: string): any {
  value = value.trim();

  // Array
  if (value.startsWith('[') && value.endsWith(']')) {
    return value.slice(1, -1).split(',').map(v => v.trim().replace(/['"]/g, ''));
  }

  // Number
  if (!isNaN(Number(value))) {
    return Number(value);
  }

  // Boolean
  if (value === 'true') return true;
  if (value === 'false') return false;

  // String
  return value.replace(/^['"]|['"]$/g, '');
}

// GET request - show admin page
const entries = getPortfolioEntries();
let isAuthenticated = false;
let message = '';
let error = '';

// Check authentication
if (Astro.request.method === 'GET') {
  const url = new URL(Astro.request.url);
  const sessionKey = url.searchParams.get('session');

  if (sessionKey === ADMIN_PASSWORD) {
    isAuthenticated = true;
  }
}

// POST request - handle CRUD operations
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action')?.toString();
  const password = formData.get('password')?.toString();

  if (password !== ADMIN_PASSWORD) {
    error = 'Invalid password';
  } else {
    isAuthenticated = true;

    switch (action) {
      case 'create':
        {
          const title = formData.get('title')?.toString() || '';
          const date = formData.get('date')?.toString() || new Date().toISOString().split('T')[0];
          const description = formData.get('description')?.toString() || '';
          const thumbnail = formData.get('thumbnail')?.toString() || '';
          const tags = formData.get('tags')?.toString() || '';
          const client = formData.get('client')?.toString() || '';
          const link = formData.get('link')?.toString() || '';
          const youtubeId = formData.get('youtubeId')?.toString() || '';
          const content = formData.get('content')?.toString() || '';

          const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
          const year = date.split('-')[0];
          const yearDir = path.join(process.cwd(), PORTFOLIO_DIR, year);

          if (!fs.existsSync(yearDir)) {
            fs.mkdirSync(yearDir, { recursive: true });
          }

          const frontmatter = `---
title: "${title}"
description: "${description}"
date: ${date}
thumbnail: "${thumbnail}"
tags: [${tags}]
client: "${client}"
link: "${link}"
youtubeId: "${youtubeId}"
---
${content}
`;

          fs.writeFileSync(path.join(yearDir, `${slug}.md`), frontmatter);
          message = `Created "${title}" successfully!`;
        }
        break;

      case 'update':
        {
          const oldSlug = formData.get('oldSlug')?.toString() || '';
          const title = formData.get('title')?.toString() || '';
          const date = formData.get('date')?.toString() || '';
          const description = formData.get('description')?.toString() || '';
          const thumbnail = formData.get('thumbnail')?.toString() || '';
          const tags = formData.get('tags')?.toString() || '';
          const client = formData.get('client')?.toString() || '';
          const link = formData.get('link')?.toString() || '';
          const youtubeId = formData.get('youtubeId')?.toString() || '';
          const content = formData.get('content')?.toString() || '';

          // Find the file and update it
          const allEntries = getPortfolioEntries();
          const entry = allEntries.find(e => e.slug === oldSlug);

          if (entry) {
            const year = date.split('-')[0];
            const yearDir = path.join(process.cwd(), PORTFOLIO_DIR, year);

            if (!fs.existsSync(yearDir)) {
              fs.mkdirSync(yearDir, { recursive: true });
            }

            const frontmatter = `---
title: "${title}"
description: "${description}"
date: ${date}
thumbnail: "${thumbnail}"
tags: [${tags}]
client: "${client}"
link: "${link}"
youtubeId: "${youtubeId}"
---
${content}
`;

            fs.writeFileSync(path.join(yearDir, `${oldSlug}.md`), frontmatter);
            message = `Updated "${title}" successfully!`;
          }
        }
        break;

      case 'delete':
        {
          const slug = formData.get('slug')?.toString() || '';
          const year = formData.get('year')?.toString() || '';

          const filePath = path.join(process.cwd(), PORTFOLIO_DIR, year, `${slug}.md`);

          if (fs.existsSync(filePath)) {
            fs.unlinkSync(filePath);
            message = `Deleted "${slug}" successfully!`;
          }
        }
        break;

    }

    // Refresh entries after CRUD
    if (action !== 'deploy') {
      Astro.locals.entries = getPortfolioEntries();
    }
  }
}

// No server-side exec needed anymore - using API endpoint
---

<Layout title="Admin - Portfolio">
  <div class="min-h-screen bg-[#0a0a0a] text-white p-8">
    <div class="max-w-6xl mx-auto">
      <header class="mb-8 flex justify-between items-center border-b border-[#222] pb-6">
        <div>
          <h1 class="text-3xl font-bold text-[#00d4ff]">Portfolio Admin</h1>
          <p class="text-[#666] mt-2">Manage portfolio entries & deploy</p>
        </div>
        <div class="text-sm text-[#666] font-mono">
          REC ‚óè {new Date().toLocaleTimeString()}
        </div>
      </header>

      {error && (
        <div class="bg-red-900/20 border border-red-500 text-red-400 p-4 rounded mb-6">
          ‚ö†Ô∏è {error}
        </div>
      )}

      {message && (
        <div class="bg-green-900/20 border border-green-500 text-green-400 p-4 rounded mb-6">
          ‚úÖ {message}
        </div>
      )}

      {!isAuthenticated ? (
        <div class="bg-[#111] border border-[#222] rounded-lg p-8 max-w-md mx-auto">
          <h2 class="text-xl font-bold mb-4">üîê Admin Login</h2>
          <form method="POST">
            <input type="password" name="password" placeholder="Enter password"
              class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white mb-4 focus:border-[#00d4ff] outline-none" />
            <button type="submit"
              class="w-full bg-[#00d4ff] text-black font-bold py-3 rounded hover:bg-[#00b8e6] transition">
              Login
            </button>
          </form>
        </div>
      ) : (
        <div class="space-y-8">
          <!-- Quick Deploy -->
          <div class="bg-[#111] border border-[#222] rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
              üöÄ Quick Deploy
            </h2>
            <p class="text-[#666] mb-4">Commit all changes & push to Git (triggers Vercel auto-deploy)</p>

            <div id="deployStatus" class="hidden mb-4 p-4 rounded"></div>

            <button id="deployButton"
              class="bg-[#00d4ff] text-black font-bold py-3 px-8 rounded hover:bg-[#00b8e6] transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
              <span id="deployButtonText">Git Push & Deploy</span>
              <span class="text-[#00d4ff]/70">‚Üí</span>
            </button>

            <div id="deployOutput" class="mt-4 p-4 bg-[#0a0a0a] rounded font-mono text-sm text-[#666] hidden overflow-x-auto">
              <pre id="deployOutputText"></pre>
            </div>
          </div>

          <!-- Create New Entry -->
          <div class="bg-[#111] border border-[#222] rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4">‚ûï Create New Entry</h2>
            <form method="POST" class="space-y-4">
              <input type="hidden" name="action" value="create" />
              <input type="hidden" name="password" value={ADMIN_PASSWORD} />

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-[#666] mb-2">Title *</label>
                  <input type="text" name="title" required
                    class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
                </div>
                <div>
                  <label class="block text-sm text-[#666] mb-2">Date *</label>
                  <input type="date" name="date" required
                    class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
                </div>
              </div>

              <div>
                <label class="block text-sm text-[#666] mb-2">Description *</label>
                <textarea name="description" required rows="3"
                  class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none"></textarea>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm text-[#666] mb-2">Thumbnail URL</label>
                  <input type="url" name="thumbnail"
                    class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
                </div>
                <div>
                  <label class="block text-sm text-[#666] mb-2">Tags (comma-separated)</label>
                  <input type="text" name="tags"
                    class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm text-[#666] mb-2">Client</label>
                  <input type="text" name="client"
                    class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
                </div>
                <div>
                  <label class="block text-sm text-[#666] mb-2">Link</label>
                  <input type="url" name="link"
                    class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
                </div>
                <div>
                  <label class="block text-sm text-[#666] mb-2">YouTube ID</label>
                  <input type="text" name="youtubeId"
                    class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
                </div>
              </div>

              <div>
                <label class="block text-sm text-[#666] mb-2">Full Content</label>
                <textarea name="content" rows="10"
                  class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none font-mono text-sm"></textarea>
              </div>

              <button type="submit"
                class="bg-[#00d4ff] text-black font-bold py-3 px-8 rounded hover:bg-[#00b8e6] transition">
                Create Entry
              </button>
            </form>
          </div>

          <!-- Existing Entries -->
          <div class="bg-[#111] border border-[#222] rounded-lg p-6">
            <h2 class="text-xl font-bold mb-4">üìö Existing Entries ({entries.length})</h2>
            {entries.length === 0 ? (
              <p class="text-[#666]">No entries yet. Create your first one above!</p>
            ) : (
              <div class="space-y-4">
                {entries.map(entry => (
                  <div class="border border-[#222] rounded p-4 flex justify-between items-start gap-4 hover:border-[#00d4ff] transition">
                    <div class="flex-1">
                      <h3 class="font-bold text-lg">{entry.title}</h3>
                      <p class="text-sm text-[#666] mt-1">{entry.date}</p>
                      {entry.thumbnail && (
                        <img src={entry.thumbnail} alt="" class="mt-2 h-12 w-20 object-cover rounded" />
                      )}
                    </div>
                    <div class="flex gap-2">
                      <button
                        class="bg-[#222] hover:bg-[#333] px-4 py-2 rounded text-sm transition"
                        onclick={`editEntry('${entry.slug}')`}>
                        Edit
                      </button>
                      <form method="POST" class="inline">
                        <input type="hidden" name="action" value="delete" />
                        <input type="hidden" name="slug" value={entry.slug} />
                        <input type="hidden" name="year" value={entry.date.split('-')[0]} />
                        <input type="hidden" name="password" value={ADMIN_PASSWORD} />
                        <button type="submit"
                          class="bg-red-900/30 hover:bg-red-900/50 text-red-400 px-4 py-2 rounded text-sm transition"
                          onclick="return confirm('Delete this entry?')">
                          Delete
                        </button>
                      </form>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4">
      <div class="bg-[#111] border border-[#222] rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Edit Entry</h2>
          <button onclick="closeEditModal()" class="text-[#666] hover:text-white text-2xl">&times;</button>
        </div>
        <form id="editForm" method="POST" class="space-y-4">
          <input type="hidden" name="action" value="update" />
          <input type="hidden" name="password" value={ADMIN_PASSWORD} />
          <input type="hidden" id="editOldSlug" name="oldSlug" />

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-[#666] mb-2">Title *</label>
              <input type="text" id="editTitle" name="title" required
                class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
            </div>
            <div>
              <label class="block text-sm text-[#666] mb-2">Date *</label>
              <input type="date" id="editDate" name="date" required
                class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
            </div>
          </div>

          <div>
            <label class="block text-sm text-[#666] mb-2">Description *</label>
            <textarea id="editDescription" name="description" required rows="3"
              class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none"></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-[#666] mb-2">Thumbnail URL</label>
              <input type="url" id="editThumbnail" name="thumbnail"
                class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
            </div>
            <div>
              <label class="block text-sm text-[#666] mb-2">Tags (comma-separated)</label>
              <input type="text" id="editTags" name="tags"
                class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-[#666] mb-2">Client</label>
              <input type="text" id="editClient" name="client"
                class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
            </div>
            <div>
              <label class="block text-sm text-[#666] mb-2">Link</label>
              <input type="url" id="editLink" name="link"
                class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
            </div>
            <div>
              <label class="block text-sm text-[#666] mb-2">YouTube ID</label>
              <input type="text" id="editYoutubeId" name="youtubeId"
                class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none" />
            </div>
          </div>

          <div>
            <label class="block text-sm text-[#666] mb-2">Full Content</label>
            <textarea id="editContent" name="content" rows="10"
              class="w-full bg-[#0a0a0a] border border-[#222] rounded p-3 text-white focus:border-[#00d4ff] outline-none font-mono text-sm"></textarea>
          </div>

          <div class="flex gap-2">
            <button type="submit"
              class="bg-[#00d4ff] text-black font-bold py-3 px-8 rounded hover:bg-[#00b8e6] transition">
              Update Entry
            </button>
            <button type="button" onclick="closeEditModal()"
              class="bg-[#222] hover:bg-[#333] py-3 px-8 rounded transition">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script define:vars={{ entries: entries.map(e => ({ slug: e.slug, ...e.frontmatter, content: e.content })), ADMIN_PASSWORD }}>
      const entriesList = entries;
      const adminPassword = ADMIN_PASSWORD;

      function editEntry(slug) {
        const entry = entriesList.find((e) => e.slug === slug);
        if (!entry) return;

        const editOldSlug = document.getElementById('editOldSlug') as HTMLInputElement;
        const editTitle = document.getElementById('editTitle') as HTMLInputElement;
        const editDate = document.getElementById('editDate') as HTMLInputElement;
        const editDescription = document.getElementById('editDescription') as HTMLTextAreaElement;
        const editThumbnail = document.getElementById('editThumbnail') as HTMLInputElement;
        const editTags = document.getElementById('editTags') as HTMLInputElement;
        const editClient = document.getElementById('editClient') as HTMLInputElement;
        const editLink = document.getElementById('editLink') as HTMLInputElement;
        const editYoutubeId = document.getElementById('editYoutubeId') as HTMLInputElement;
        const editContent = document.getElementById('editContent') as HTMLTextAreaElement;

        if (editOldSlug) editOldSlug.value = entry.slug;
        if (editTitle) editTitle.value = entry.title || '';
        if (editDate) editDate.value = entry.date || '';
        if (editDescription) editDescription.value = entry.description || '';
        if (editThumbnail) editThumbnail.value = entry.thumbnail || '';
        if (editTags) editTags.value = Array.isArray(entry.tags) ? entry.tags.join(', ') : entry.tags || '';
        if (editClient) editClient.value = entry.client || '';
        if (editLink) editLink.value = entry.link || '';
        if (editYoutubeId) editYoutubeId.value = entry.youtubeId || '';
        if (editContent) editContent.value = entry.content || '';

        const modal = document.getElementById('editModal') as HTMLElement;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function closeEditModal() {
        const modal = document.getElementById('editModal') as HTMLElement;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      // Deploy functionality
      document.getElementById('deployButton')?.addEventListener('click', async () => {
        const button = document.getElementById('deployButton') as HTMLButtonElement;
        const buttonText = document.getElementById('deployButtonText') as HTMLElement;
        const status = document.getElementById('deployStatus') as HTMLDivElement;
        const output = document.getElementById('deployOutput') as HTMLDivElement;
        const outputText = document.getElementById('deployOutputText') as HTMLElement;

        if (!button || !buttonText || !status || !output || !outputText) return;

        button.disabled = true;
        buttonText.textContent = 'Deploying...';
        status.classList.remove('hidden');
        status.className = 'mb-4 p-4 rounded bg-blue-900/20 border border-blue-500 text-blue-400';
        status.textContent = '‚è≥ Starting deployment...';
        output.classList.remove('hidden');
        outputText.textContent = '';

        try {
          const formData = new FormData();
          formData.append('password', adminPassword);

          const response = await fetch('/api/deploy', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            status.className = 'mb-4 p-4 rounded bg-green-900/20 border border-green-500 text-green-400';
            status.textContent = '‚úÖ ' + result.message;
            outputText.textContent = result.output || 'Deployment initiated successfully!';
          } else {
            status.className = 'mb-4 p-4 rounded bg-red-900/20 border border-red-500 text-red-400';
            status.textContent = '‚ùå Deployment failed';
            outputText.textContent = result.error || 'Unknown error occurred';
          }
        } catch (err) {
          status.className = 'mb-4 p-4 rounded bg-red-900/20 border border-red-500 text-red-400';
          status.textContent = '‚ùå Deployment failed';
          outputText.textContent = (err as Error).message || 'Network error occurred';
        } finally {
          button.disabled = false;
          buttonText.textContent = 'Git Push & Deploy';
        }
      });
    </script>
  </div>
</Layout>
