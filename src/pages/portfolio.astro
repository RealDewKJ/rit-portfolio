---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const allEntries = await getCollection('portfolio');
const entries = allEntries.sort((a, b) => 
  b.data.date.valueOf() - a.data.date.valueOf()
);
---

<Layout title="Portfolio | Rit">
  <div class="max-w-4xl mx-auto px-6 py-12">
    <!-- Timeline indicator -->
    <div class="flex items-center gap-2 text-xs font-mono text-video-accent mb-8">
      <div class="w-2 h-2 bg-video-accent rounded-full animate-pulse"></div>
      <span>‚óè PORTFOLIO</span>
      <span class="text-video-muted">|</span>
      <span class="font-mono">00:00:00:00</span>
    </div>

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-4xl md:text-5xl font-display font-bold tracking-tight mb-4 text-[var(--video-heading)]">
        Portfolio
      </h1>
      <p class="text-video-muted text-lg">
        A collection of my video editing projects, from music videos to commercials and documentaries.
      </p>
    </div>

    <!-- Search Bar -->
    <div class="search-container mb-12">
      <input
        type="text"
        id="searchInput"
        placeholder="Search portfolio..."
        class="w-full px-4 py-3 bg-video-surface border-2 border-video-border rounded-full text-[var(--video-text)] text-sm focus:outline-none focus:border-video-accent transition-colors placeholder:text-[var(--video-muted)]"
      >
      <button 
        id="searchClear"
        class="absolute right-4 top-1/2 -translate-y-1/2 bg-video-surface border border-video-border rounded-full w-7 h-7 flex items-center justify-center text-video-muted cursor-pointer text-xs hover:border-video-accent hover:text-video-accent transition-all opacity-0 pointer-events-none"
        aria-label="Clear search"
      >
        ‚úï
      </button>
    </div>

    <h2 class="text-2xl font-display font-semibold mb-6 text-video-heading">
      All Projects
    </h2>

    <div id="projectsContainer" class="space-y-4">
      {entries.map((entry) => {
        const filename = entry.id.split('/').pop()?.replace('.md', '') || entry.slug;
        return (
        <a href={`/portfolio/${filename}/`} class="block group">
          <div class="project-card bg-video-surface border border-video-border rounded-lg overflow-hidden transition-all hover:border-video-accent hover:translate-y-[-4px]">
            {entry.data.thumbnail && (
              <div class="aspect-video bg-video-bg overflow-hidden">
                <img 
                  src={entry.data.thumbnail} 
                  alt={entry.data.title}
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                />
              </div>
            )}
            <div class="project-info p-6">
              <h3 class="project-title font-display font-semibold text-lg mb-2 text-video-heading group-hover:text-video-accent transition-colors">
                {entry.data.title}
              </h3>
              <p class="project-desc text-video-muted text-sm mb-3">
                {entry.data.description}
              </p>
              <div class="tags flex flex-wrap gap-2 mb-3">
                {entry.data.tags?.map((tag: string) => (
                  <span class="px-3 py-1 bg-video-bg border border-video-border rounded-full text-xs text-video-muted">
                    {tag}
                  </span>
                ))}
              </div>
              <div class="project-meta flex items-center justify-between text-xs text-video-muted">
                <span class="font-mono">
                  {entry.data.date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                  })}
                </span>
                <span>{entry.data.client}</span>
              </div>
            </div>
          </div>
        </a>
        );
      })}
    </div>

    <!-- No Results Message -->
    <div class="no-results text-center py-12 text-video-muted text-lg hidden" id="noResults">
      <p>üîç No projects found matching your search.</p>
      <p class="text-sm mt-2">Try different keywords.</p>
    </div>

    <style>
      .search-container {
        position: relative;
        max-width: 600px;
      }
      .project-card.hidden {
        display: none;
      }
      .no-results.visible {
        display: block;
      }
    </style>
  </div>
</Layout>

<script>
  // Search Functionality
  const searchInput = document.getElementById('searchInput');
  const searchClear = document.getElementById('searchClear');
  const projects = document.querySelectorAll('.project-card');
  const noResults = document.getElementById('noResults');

  function searchProjects() {
    const query = searchInput.value.toLowerCase().trim();
    
    if (query === '') {
      projects.forEach(project => {
        project.parentElement.classList.remove('hidden');
      });
      noResults.classList.remove('visible');
      searchClear.classList.remove('opacity-100', 'pointer-events-auto');
      return;
    }

    searchClear.classList.add('opacity-100', 'pointer-events-auto');
    let hasResults = false;

    projects.forEach(project => {
      const card = project.parentElement;
      const title = project.querySelector('.project-title')?.textContent || '';
      const tags = Array.from(project.querySelectorAll('.tag')).map(t => t.textContent) || [];
      const client = project.querySelector('.project-meta span:last-child')?.textContent || '';
      
      if (title.toLowerCase().includes(query) || 
          tags.some(t => t.toLowerCase().includes(query)) || 
          client.toLowerCase().includes(query)) {
        card.classList.remove('hidden');
        hasResults = true;
      } else {
        card.classList.add('hidden');
      }
    });

    if (hasResults) {
      noResults.classList.remove('visible');
    } else {
      noResults.classList.add('visible');
    }
  }

  function clearSearch() {
    searchInput.value = '';
    searchProjects();
  }

  searchInput.addEventListener('input', searchProjects);
  searchClear.addEventListener('click', clearSearch);
</script>
